<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BRUTAL | Premium Clothing</title>

  <style>
    /* ===== RESET ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #ffffff;
      color: #000000;
      overflow-x: hidden;
    }

    /* ===== HEADER ===== */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: #ffffff;
      border-bottom: 3px solid #000;
      z-index: 1000;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .menu-btn {
      font-size: 26px;
      font-weight: bold;
      cursor: pointer;
      border: 3px solid #000;
      padding: 4px 12px;
      background: #fff;
    }

    .brand {
      font-size: 22px;
      font-weight: 900;
      letter-spacing: 3px;
    }

    .cart-btn {
      padding: 10px 20px;
      border: 3px solid #000;
      background: #000;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
    }

    .cart-btn:hover {
      background: #fff;
      color: #000;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      position: fixed;
      top: 64px;
      left: -260px;
      width: 260px;
      height: calc(100vh - 64px);
      background: #000;
      color: #fff;
      padding: 20px;
      transition: left 0.3s ease;
      z-index: 999;
      overflow-y: auto;
    }

    .sidebar.active { left: 0; }

    .sidebar h3 {
      margin-bottom: 16px;
      font-size: 18px;
      border-bottom: 2px solid #fff;
      padding-bottom: 8px;
    }

    .category {
      cursor: pointer;
      padding: 10px 0;
      border-bottom: 1px solid #444;
      text-transform: uppercase;
      font-size: 14px;
      transition: all 0.2s;
    }

    .category:hover, .category.active {
      background: #fff;
      color: #000;
      padding-left: 10px;
    }

    /* ===== CART MODAL ===== */
    .cart-modal {
      position: fixed;
      top: 64px;
      right: -400px;
      width: 380px;
      height: calc(100vh - 64px);
      background: #fff;
      border-left: 3px solid #000;
      padding: 20px;
      transition: right 0.3s ease;
      z-index: 999;
      overflow-y: auto;
    }

    .cart-modal.active { right: 0; }

    .cart-modal h3 {
      margin-bottom: 20px;
      font-size: 20px;
      border-bottom: 2px solid #000;
      padding-bottom: 10px;
    }

    .cart-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 0;
      border-bottom: 1px solid #ddd;
    }

    .cart-item img {
      width: 80px;
      height: 100px;
      object-fit: cover;
      border: 2px solid #000;
    }

    .cart-item-info {
      flex-grow: 1;
    }

    .cart-item-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .cart-item-price {
      color: #555;
      margin-bottom: 10px;
    }

    .cart-item-quantity {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .quantity-btn {
      width: 25px;
      height: 25px;
      border: 2px solid #000;
      background: #fff;
      font-weight: bold;
      cursor: pointer;
    }

    .quantity-btn:hover {
      background: #000;
      color: #fff;
    }

    .remove-btn {
      padding: 5px 10px;
      border: 2px solid #f00;
      background: #fff;
      color: #f00;
      font-size: 12px;
      cursor: pointer;
    }

    .remove-btn:hover {
      background: #f00;
      color: #fff;
    }

    .cart-total {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #000;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
    }

    .checkout-btn {
      width: 100%;
      padding: 15px;
      margin-top: 20px;
      border: 3px solid #000;
      background: #000;
      color: #fff;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      text-transform: uppercase;
    }

    .checkout-btn:hover {
      background: #fff;
      color: #000;
    }

    /* ===== MAIN ===== */
    main {
      padding: 100px 20px 40px;
      max-width: 1400px;
      margin: 0 auto;
      min-height: 80vh;
    }

    .catalog {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 24px;
    }

    /* ===== CARD ===== */
    .card {
      border: 3px solid #000;
      padding: 16px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.2s;
      background: white;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .card img {
      width: 100%;
      height: 320px;
      object-fit: cover;
      border: 2px solid #000;
      margin-bottom: 12px;
      background: #f5f5f5;
    }

    .card h4 {
      font-size: 16px;
      margin-bottom: 6px;
      text-transform: uppercase;
      height: 40px;
      overflow: hidden;
      line-height: 1.2;
    }

    .card-categories {
      margin: 8px 0;
      font-size: 12px;
      color: #666;
      min-height: 30px;
    }

    .card-category {
      display: inline-block;
      background: #f0f0f0;
      padding: 2px 8px;
      margin-right: 5px;
      margin-bottom: 5px;
      border-radius: 3px;
    }

    .price {
      font-size: 18px;
      font-weight: bold;
      margin: 8px 0;
      color: #000;
    }

    .add-btn {
      padding: 10px;
      border: 3px solid #000;
      background: #000;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.2s;
    }

    .add-btn:hover {
      background: #fff;
      color: #000;
    }

    .add-btn:disabled {
      background: #ccc;
      border-color: #ccc;
      color: #666;
      cursor: not-allowed;
    }

    /* ===== LOADER & ERROR ===== */
    .loader {
      text-align: center;
      font-size: 20px;
      margin-top: 60px;
      padding: 40px;
    }

    .error {
      text-align: center;
      font-size: 18px;
      margin-top: 60px;
      color: red;
      padding: 40px;
      background: #fff5f5;
      border: 2px solid red;
    }

    .empty-catalog, .empty-cart {
      text-align: center;
      color: #666;
      padding: 60px 20px;
      font-size: 18px;
      grid-column: 1 / -1;
    }

    /* ===== TOAST NOTIFICATION ===== */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 24px;
      background: #000;
      color: #fff;
      border: 3px solid #000;
      font-weight: bold;
      z-index: 10000;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s, transform 0.3s;
      max-width: 300px;
      text-align: center;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.success {
      background: #000;
      color: #fff;
      border-color: #000;
    }

    .toast.error {
      background: #f00;
      color: #fff;
      border-color: #f00;
    }

    /* ===== SESSION DEBUG ===== */
    .session-debug {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 12px;
      font-size: 11px;
      font-family: monospace;
      border-radius: 4px;
      z-index: 10000;
      max-width: 200px;
      word-break: break-all;
      display: none;
    }
  </style>
</head>
<body>

<div id="toast" class="toast" style="display: none;"></div>
<div id="sessionDebug" class="session-debug"></div>

<header>
  <div class="header-left">
    <div class="menu-btn" id="menuBtn">☰</div>
    <div class="brand">BRUTAL</div>
  </div>
  <button class="cart-btn" id="cartBtn">Cart (<span id="cartCount">0</span>)</button>
</header>

<aside class="sidebar" id="sidebar">
  <h3>Categories</h3>
  <div class="category active" id="allCategory">All</div>
  <div id="categoryList"></div>
</aside>

<aside class="cart-modal" id="cartModal">
  <h3>Your Cart</h3>
  <div id="cartItems"></div>
  <div class="cart-total">
    <span>Total:</span>
    <span id="cartTotal">0 ₽</span>
  </div>
  <button class="checkout-btn" id="checkoutBtn">Checkout</button>
</aside>

<main>
  <div class="catalog" id="catalog"></div>
  <div class="loader" id="loader">Loading catalog...</div>
  <div class="error" id="error" style="display:none"></div>
</main>

<script>
  // ===== КОНФИГУРАЦИЯ =====
  // Автоматическое определение URL
  let API_BASE = '';

  // Если фронтенд запущен отдельно (не через FastAPI), используем полный URL
  if (window.location.port !== '8000' && window.location.hostname !== '127.0.0.1') {
    API_BASE = 'http://127.0.0.1:8000';
  }

  console.log('Frontend URL:', window.location.href);
  console.log('API Base URL:', API_BASE || '(relative)');

  // DOM элементы
  const catalogEl = document.getElementById("catalog");
  const loaderEl = document.getElementById("loader");
  const errorEl = document.getElementById("error");
  const sidebar = document.getElementById("sidebar");
  const cartModal = document.getElementById("cartModal");
  const menuBtn = document.getElementById("menuBtn");
  const cartBtn = document.getElementById("cartBtn");
  const categoryList = document.getElementById("categoryList");
  const allCategoryBtn = document.getElementById("allCategory");
  const cartItemsEl = document.getElementById("cartItems");
  const cartCountEl = document.getElementById("cartCount");
  const cartTotalEl = document.getElementById("cartTotal");
  const checkoutBtn = document.getElementById("checkoutBtn");
  const toastEl = document.getElementById("toast");
  const sessionDebugEl = document.getElementById("sessionDebug");

  // Глобальные переменные
  let allItems = [];
  let currentCategory = null;
  let cart = [];
  let currentSessionId = null;

  // ===== УТИЛИТЫ =====
  function showToast(message, type = 'success', duration = 1500) {
    toastEl.textContent = message;
    toastEl.className = 'toast ' + type;
    toastEl.style.display = 'block';

    setTimeout(() => {
      toastEl.classList.add('show');
    }, 10);

    setTimeout(() => {
      toastEl.classList.remove('show');
      setTimeout(() => {
        toastEl.style.display = 'none';
      }, 300);
    }, duration);
  }

  function updateSessionDebug(sessionId) {
    if (sessionDebugEl) {
      if (sessionId) {
        sessionDebugEl.textContent = `Session: ${sessionId.substring(0, 15)}...`;
        sessionDebugEl.title = `Full session ID: ${sessionId}`;
        sessionDebugEl.style.display = 'block';
      } else {
        sessionDebugEl.style.display = 'none';
      }
    }
  }

  // ===== РАБОТА С API =====
  async function makeRequest(url, method = 'GET', body = null) {
    const options = {
      method,
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      credentials: 'include' // ОБЯЗАТЕЛЬНО для передачи cookies с session_id
    };

    if (body && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
      options.body = JSON.stringify(body);
    }

    const fullUrl = API_BASE ? `${API_BASE}${url}` : url;
    console.log(`${method} ${fullUrl}`, options);

    try {
      const response = await fetch(fullUrl, options);

      // Сохраняем session_id из ответа если есть
      const sessionIdFromResponse = response.headers.get('X-Session-ID') ||
                                   response.headers.get('session-id');
      if (sessionIdFromResponse) {
        currentSessionId = sessionIdFromResponse;
        updateSessionDebug(currentSessionId);
      }

      if (!response.ok) {
        let errorDetail = `HTTP ${response.status}`;
        try {
          const errorData = await response.json();
          errorDetail = errorData.detail || JSON.stringify(errorData);
        } catch {
          errorDetail = await response.text();
        }
        throw new Error(errorDetail);
      }

      const data = await response.json();

      // Сохраняем session_id из тела ответа если есть
      if (data.session_id) {
        currentSessionId = data.session_id;
        updateSessionDebug(currentSessionId);
      }

      return data;
    } catch (error) {
      console.error(`Request failed: ${url}`, error);
      throw error;
    }
  }

  async function fetchItems() {
    try {
      const data = await makeRequest('/get_item');
      return data.items || [];
    } catch (error) {
      console.error("Error fetching items:", error);
      throw error;
    }
  }

  async function loadCartFromServer() {
    try {
      const data = await makeRequest('/get_cart');

      // Обновляем session_id если он пришел с сервера
      if (data.session_id) {
        currentSessionId = data.session_id;
        updateSessionDebug(currentSessionId);
      }

      // Преобразуем данные из сервера в формат фронтенда
      cart = (data.cart_items || []).map(item => ({
        item_id: item.item_id,
        item_name: item.item_name,
        item_price: item.item_price,
        item_image: item.item_image,
        quantity: item.quantity,
        total_price: item.total_price
      }));

      updateCartUI();
      console.log('Cart loaded from server:', cart);

      return cart;
    } catch (error) {
      console.error('Error loading cart from server:', error);
      // Не показываем ошибку пользователю - просто оставляем пустую корзину
      cart = [];
      updateCartUI();
      return [];
    }
  }

  async function addToCart(itemId, quantity = 1) {
    const item = allItems.find(i => i.id === itemId);
    if (!item) {
      showToast('Item not found', 'error', 2000);
      return;
    }

    try {
      const params = new URLSearchParams({
        item_id: itemId,
        quantity: quantity
      }).toString();

      const data = await makeRequest(`/cart/add?${params}`, 'POST', {});

      // Обновляем локальную корзину
      const existingItem = cart.find(c => c.item_id === itemId);
      if (existingItem) {
        existingItem.quantity = data.quantity;
        existingItem.total_price = existingItem.item_price * data.quantity;
      } else {
        cart.push({
          item_id: itemId,
          item_name: item.name,
          item_price: item.price,
          item_image: item.image,
          quantity: data.quantity,
          total_price: item.price * data.quantity
        });
      }

      updateCartUI();
      showToast('Added to cart', 'success');

      return data;
    } catch (error) {
      console.error("Error adding to cart:", error);

      let errorMsg = 'Failed to add item';
      if (error.message.includes('Failed to fetch')) {
        errorMsg = 'Server connection error';
      }

      showToast(errorMsg, 'error', 2000);
      throw error;
    }
  }

  async function removeFromCart(itemId, quantity = 1) {
    try {
      const params = new URLSearchParams({
        item_id: itemId,
        quantity: quantity
      }).toString();

      const data = await makeRequest(`/remove_item_from_cart?${params}`, 'DELETE');

      // Обновляем локальную корзину на основе ответа сервера
      const itemIndex = cart.findIndex(item => item.item_id === itemId);

      if (itemIndex !== -1) {
        if (data.remaining_quantity === 0) {
          cart.splice(itemIndex, 1);
          showToast('Item removed', 'success');
        } else {
          cart[itemIndex].quantity = data.remaining_quantity;
          cart[itemIndex].total_price = cart[itemIndex].item_price * data.remaining_quantity;
          showToast('Quantity updated', 'success');
        }
      }

      updateCartUI();
      return data;
    } catch (error) {
      console.error("Error removing from cart:", error);

      let errorMsg = 'Failed to update cart';
      if (error.message.includes('404')) {
        errorMsg = 'Item not in cart';
      } else if (error.message.includes('400')) {
        errorMsg = 'Invalid quantity';
      } else if (error.message.includes('Failed to fetch')) {
        errorMsg = 'Server connection error';
      }

      showToast(errorMsg, 'error', 2000);

      // Fallback: обновляем локально для UX
      const localIndex = cart.findIndex(item => item.item_id === itemId);
      if (localIndex !== -1) {
        if (quantity >= cart[localIndex].quantity) {
          cart.splice(localIndex, 1);
        } else {
          cart[localIndex].quantity -= quantity;
          cart[localIndex].total_price = cart[localIndex].item_price * cart[localIndex].quantity;
        }
        updateCartUI();
      }

      throw error;
    }
  }

  // ===== РЕНДЕРИНГ =====
  function renderCatalog(items) {
    catalogEl.innerHTML = "";

    if (!items || items.length === 0) {
      catalogEl.innerHTML = '<div class="empty-catalog">No items found</div>';
      return;
    }

    items.forEach(item => {
      const card = document.createElement("div");
      card.className = "card";

      const categoriesHTML = item.categories && item.categories.length > 0
        ? `<div class="card-categories">
             ${item.categories.map(cat =>
               `<span class="card-category" title="${cat.description || ''}">${cat.name}</span>`
             ).join('')}
           </div>`
        : '';

      const isAvailable = item.availability_status !== false && (item.quantity > 0 || item.quantity === undefined);
      const price = item.price || 0;

      card.innerHTML = `
        <img src="${item.image || 'https://via.placeholder.com/300x400'}"
             alt="${item.name}"
             onerror="this.src='https://via.placeholder.com/300x400'"
             loading="lazy" />
        <h4 title="${item.name}">${item.name}</h4>
        ${categoriesHTML}
        <div class="price">${price.toLocaleString('ru-RU')} ₽</div>
        <div style="font-size: 12px; color: ${isAvailable ? 'green' : 'red'}; margin: 5px 0;">
          ${isAvailable ? `In stock${item.quantity ? ': ' + item.quantity : ''}` : 'Out of stock'}
        </div>
        <button class="add-btn" ${!isAvailable ? 'disabled' : ''}>
          ${isAvailable ? 'Add to cart' : 'Out of stock'}
        </button>
      `;

      if (isAvailable) {
        card.querySelector(".add-btn").onclick = () => addToCart(item.id);
      }

      catalogEl.appendChild(card);
    });
  }

  function renderCategories(items) {
    categoryList.innerHTML = "";
    const categories = new Map();

    items.forEach(item => {
      if (item.categories && Array.isArray(item.categories)) {
        item.categories.forEach(cat => {
          if (cat && cat.id && cat.name) {
            categories.set(cat.id, {name: cat.name, description: cat.description});
          }
        });
      }
    });

    const sortedCategories = new Map([...categories.entries()].sort((a, b) =>
      a[1].name.localeCompare(b[1].name)
    ));

    if (sortedCategories.size === 0) {
      categoryList.innerHTML = '<div style="color: #999; font-style: italic;">No categories</div>';
      return;
    }

    sortedCategories.forEach((cat, id) => {
      const div = document.createElement("div");
      div.className = "category";
      div.textContent = cat.name;
      div.title = cat.description || cat.name;
      div.dataset.categoryId = id;
      div.onclick = () => filterByCategory(id, div);
      categoryList.appendChild(div);
    });
  }

  function filterByCategory(categoryId, clickedElement) {
    document.querySelectorAll('.category').forEach(cat => {
      cat.classList.remove('active');
    });

    if (categoryId === 'all') {
      allCategoryBtn.classList.add('active');
      currentCategory = null;
      renderCatalog(allItems);
    } else {
      clickedElement.classList.add('active');
      allCategoryBtn.classList.remove('active');
      currentCategory = categoryId;

      const filtered = allItems.filter(item =>
        item.categories && item.categories.some(cat => cat.id === categoryId)
      );
      renderCatalog(filtered);
    }

    sidebar.classList.remove("active");
  }

  function updateCartUI() {
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartCountEl.textContent = totalItems;

    cartItemsEl.innerHTML = "";

    if (cart.length === 0) {
      cartItemsEl.innerHTML = '<div class="empty-cart">Your cart is empty</div>';
      cartTotalEl.textContent = "0 ₽";
      return;
    }

    let totalPrice = 0;

    cart.forEach(item => {
      totalPrice += item.total_price;

      const cartItemEl = document.createElement("div");
      cartItemEl.className = "cart-item";
      cartItemEl.innerHTML = `
        <img src="${item.item_image || 'https://via.placeholder.com/80x100'}"
             alt="${item.item_name}"
             onerror="this.src='https://via.placeholder.com/80x100'" />
        <div class="cart-item-info">
          <div class="cart-item-name">${item.item_name}</div>
          <div class="cart-item-price">${item.item_price.toLocaleString()} ₽ × ${item.quantity}</div>
          <div class="cart-item-quantity">
            <button class="quantity-btn decrease" data-item-id="${item.item_id}">-</button>
            <span>${item.quantity}</span>
            <button class="quantity-btn increase" data-item-id="${item.item_id}">+</button>
            <button class="remove-btn" data-item-id="${item.item_id}">Remove</button>
          </div>
        </div>
        <div style="font-weight: bold;">${item.total_price.toLocaleString()} ₽</div>
      `;

      cartItemsEl.appendChild(cartItemEl);
    });

    cartTotalEl.textContent = `${totalPrice.toLocaleString()} ₽`;

    document.querySelectorAll('.decrease').forEach(btn => {
      btn.onclick = () => removeFromCart(parseInt(btn.dataset.itemId), 1);
    });

    document.querySelectorAll('.increase').forEach(btn => {
      btn.onclick = () => addToCart(parseInt(btn.dataset.itemId), 1);
    });

    document.querySelectorAll('.remove-btn').forEach(btn => {
      btn.onclick = () => removeFromCart(parseInt(btn.dataset.itemId), 9999);
    });
  }

  // ===== УПРАВЛЕНИЕ UI =====
  menuBtn.onclick = () => sidebar.classList.toggle("active");
  cartBtn.onclick = () => {
    cartModal.classList.toggle("active");
    // При открытии корзины загружаем актуальные данные с сервера
    if (cartModal.classList.contains("active")) {
      loadCartFromServer();
    }
  };

  document.addEventListener('click', (e) => {
    if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
      sidebar.classList.remove("active");
    }
    if (!cartModal.contains(e.target) && !cartBtn.contains(e.target)) {
      cartModal.classList.remove("active");
    }
  });

  // ===== ИНИЦИАЛИЗАЦИЯ =====
  async function init() {
    try {
      // 1. Загружаем товары
      allItems = await fetchItems();

      // 2. Загружаем корзину с сервера (это создаст session_id если его еще нет)
      await loadCartFromServer();

      // 3. Скрываем лоадер и показываем контент
      loaderEl.style.display = "none";

      // 4. Рендерим каталог и категории
      renderCatalog(allItems);
      renderCategories(allItems);

      // 5. Настраиваем обработчики
      allCategoryBtn.onclick = () => filterByCategory('all', allCategoryBtn);

    } catch (err) {
      console.error("Initialization error:", err);
      loaderEl.style.display = "none";
      errorEl.style.display = "block";

      errorEl.innerHTML = `
        <div style="margin-bottom: 20px;">
          <strong>Failed to load catalog</strong>
        </div>
        <div style="margin-bottom: 10px;">Error: ${err.message}</div>
        <div style="font-size: 14px; margin-top: 20px;">
          <strong>Troubleshooting:</strong>
          <ol style="text-align: left; max-width: 500px; margin: 10px auto;">
            <li>Make sure backend is running: <code>uvicorn main:app --reload</code></li>
            <li>Check API endpoint:
              <a href="${API_BASE || 'http://127.0.0.1:8000'}/get_item" target="_blank">
                ${API_BASE || 'http://127.0.0.1:8000'}/get_item
              </a>
            </li>
            <li>Open <a href="${API_BASE || 'http://127.0.0.1:8000'}/docs" target="_blank">Swagger UI</a> to test API</li>
            ${currentSessionId ? `<li>Current session: ${currentSessionId.substring(0, 20)}...</li>` : ''}
          </ol>
        </div>
        <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px; background: #000; color: white; border: none; cursor: pointer;">
          Retry
        </button>
      `;

      // Показываем тестовые данные для отладки UI
      const testItems = [
        {
          id: 1,
          name: "Brutal T-Shirt",
          price: 2999,
          image: "https://via.placeholder.com/300x400",
          categories: [{id: 1, name: "Clothing", description: "Clothing items"}],
          availability_status: true,
          quantity: 10
        },
        {
          id: 2,
          name: "Minimalist Hoodie",
          price: 5999,
          image: "https://via.placeholder.com/300x400",
          categories: [{id: 1, name: "Clothing"}, {id: 2, name: "Winter"}],
          availability_status: true,
          quantity: 5
        }
      ];

      allItems = testItems;
      renderCatalog(allItems);
      renderCategories(allItems);
    }
  }

  // Обработчик оформления заказа
  checkoutBtn.onclick = async () => {
    if (cart.length === 0) {
      showToast('Your cart is empty', 'error', 2000);
      return;
    }

    const total = cart.reduce((sum, item) => sum + item.total_price, 0);

    if (confirm(`Confirm order?\n\nTotal: ${total.toLocaleString()} ₽`)) {
      try {
        // Здесь можно добавить вызов API для создания заказа
        // const orderData = await makeRequest('/create_order', 'POST', { items: cart });

        showToast('Order placed successfully!', 'success', 3000);

        // Очищаем корзину после оформления заказа
        cart = [];
        updateCartUI();
        cartModal.classList.remove("active");

        // Перезагружаем корзину с сервера чтобы убедиться что она пуста
        await loadCartFromServer();
      } catch (error) {
        showToast('Failed to place order', 'error', 3000);
      }
    }
  };

  // Запуск приложения
  document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>